# Environment hyperparameters and scenario layout
# 切换到 grid1x3：3 个信号路口（J0, J1, J2），主路东向三段
segments: ["J0_J1", "J1_J2", "J2_E"]
action_speeds_mps: [8.33, 10.0, 12.0, 14.0]
# 统一配置：训练与环境使用同一来源
sumo_cfg_relpath: "sumo/grid1x3.sumocfg"
# VSL控制区域：仅控制直行车道（Lane 1），集中控制力于绿波收益最大的流向
lane_groups:
  upstream: ["W_J0_1"]   # 控制W→J0直行车道（J0信号灯上游）
  mid: ["J0_J1_1"]       # 控制J0→J1直行车道（J1信号灯上游）
  down: ["J1_J2_1"]      # 控制J1→J2直行车道（J2信号灯上游）
lane_groups_wb:
  upstream: ["E_J2_1"]   # 控制E→J2直行车道（J2西向上游）
  mid: ["J2_J1_1"]       # 控制J2→J1直行车道（J1西向上游）
  down: ["J1_J0_1"]      # 控制J1→J0直行车道（J0西向上游）
tls_ids: ["J0", "J1", "J2"]
detector_ids:
  - det_J0_J1_0
  - det_J0_J1_1
  - det_J0_J1_2
  - det_J1_J2_0
  - det_J1_J2_1
  - det_J1_J2_2
  - det_J2_E_0
  - det_J2_E_1
  - det_J2_E_2
  - det_E_J2_0
  - det_E_J2_1
  - det_E_J2_2
  - det_J2_J1_0
  - det_J2_J1_1
  - det_J2_J1_2
  - det_J1_J0_0
  - det_J1_J0_1
  - det_J1_J0_2
discrete_speeds_kph: [30, 35, 40, 45, 50, 55]
# 决策间隔优化：基于精确绿波匹配（offset=17s）
# 理论通行时间：229.2m ÷ 13.89m/s ≈ 16.5s，向上取整为17s
decision_interval: 17  # 论文优化：精确对齐绿波offset（原15s）
# 仿真时长3600s，决策间隔17s => 212决策步
max_steps: 212  # 3600s / 17s ≈ 212步
warmup_steps: 825  # 165s × 5 = 825s（5个完整信号周期预热）

# Training hyperparameters
device: "cuda"  # 设备选择：auto/cuda/cpu，默认为 cuda（若不可用会自动回退）
episodes: 50  # 用户偏好：50轮观察收敛效果
save_every_n_episodes: 10  # 每10回合保存一次
epsilon_start: 1.0
epsilon_end: 0.01
epsilon_decay_steps: 60000
batch_size: 128          # 论文优化：减小batch提高更新频率（原256）
gamma: 0.995             # 论文优化：提高折扣因子重视长期回报（原0.99）
# 解释：17s决策间隔下，gamma=0.995^(165/17)≈0.95（覆盖完整信号周期）
# 学习率优化：针对长周期环境
learning_rate: 2e-4      # 论文优化：降低基础学习率，稳定训练
actor_lr: 1e-4           # 论文优化：策略网络更保守学习（原2e-4）
critic_lr: 3e-4          # 论文优化：Q网络适当降低（原5e-4）
buffer_size: 200000
# 预填充随机采样步数（训练开始前先用随机策略填充经验池）
prefill_steps: 5000

# ========== SAC核心参数（论文优化：基于offset=17s绿波匹配） ==========
sac_tau: 0.005  # 软更新系数：降低以适应长周期环境（原0.01）
sac_alpha: 0.15  # 初始温度：降低以减少初期过度探索（原0.2）
sac_auto_alpha: true  # 自适应温度：必须开启以应对信号相位变化
# SAC alpha 学习率：提高以加快温度自适应速度
sac_alpha_lr: 2e-3  # 论文优化：加快探索-利用平衡调节（原1e-3）
# 目标网络软更新：每步更新，平滑应对165s周期内的状态变化
sac_target_update_interval: 1
# 目标熵优化：基于精确绿波匹配，绿波成功率高，可适当提升探索
# 原理：offset=17s精确匹配后，绿波命中率提升，智能体有余力探索多种策略
sac_target_entropy: 3.5  # 最终优化：实验验证最优值（低熵高确定性，配合GW=8.0）
# Alpha范围约束：适度放宽以适应高绿波命中率环境
sac_alpha_min: 0.02  # 保持下限，避免完全确定性
sac_alpha_max: 0.7   # 提升上限，鼓励绿灯期探索（原0.6）

# ========== SAC算法改进配置 ==========
# 策略延迟更新：每N步更新一次策略（降低策略震荡）
sac_policy_delay: 1  # A/B测试最优：基线配置不延迟更新
# Dropout正则化：防止过拟合（建议0.0-0.1，观察Q_loss曲线后调整）
sac_dropout: 0.0  # A/B测试最优：基线配置不使用dropout
# L2权重衰减：抑制Q值爆炸
sac_weight_decay: 0.0  # A/B测试最优：基线配置不使用权重衰减
# Q网络不向策略反向传播（离散策略中默认开启更稳定）
sac_actor_detach_q: true
# 通用网络与训练稳定性
hidden_size: 256
grad_clip_norm: 5.0

# 环境奖励裁剪（SAC 放宽以提升拥堵信号穿透力）
reward_clip_min: -10.0
reward_clip_max: 10.0

# Scenario generation
penetration: 0.3

# CAV vehicle parameters (IDM model)
# 统一训练与评估的CAV物理参数，避免环境不一致
cav_tau: 0.5              # CAV反应时间(s), 符合AV假设
cav_accel: 3.0            # CAV最大加速度(m/s²)
cav_decel: 4.5            # CAV最大减速度(m/s²)
cav_min_gap: 0.50         # CAV最小车距(m)
cav_speed_dev: 0.0        # CAV速度偏差(归一化)
cav_sigma: 0              # CAV驾驶不完美度

# HV vehicle parameters (IDM model)
hv_tau: 1.5               # HV反应时间(s), 传统驾驶员假设
hv_accel: 2.5             # HV最大加速度(m/s²)
hv_decel: 4.5             # HV最大减速度(m/s²)
hv_min_gap: 0.50          # HV最小车距(m)
hv_speed_dev: 0.05        # HV速度偏差(归一化)

# ========== 奖励函数权重（论文核心：基于offset=17s精确绿波匹配） ==========
# 设计原则：绿波已优化，适度降低绿波权重，强化速度和拥堵控制
reward_speed_weight: 3.5          # 论文优化：提升速度奖励（绿波畅通后关注效率）
reward_bottleneck_weight: 2.5     # 保持下游瓶颈权重
reward_congestion_weight: 0.8     # 论文优化：提升拥堵惩罚（绿波畅通后拥堵是真实问题）
queue_weight_eb: 0.3              # 论文优化：提升队列惩罚权重（绿波改善后关注排队）
queue_weight_wb: 0.3              # 保持对称
reward_change_penalty: 0.01       # 保持低频调速惩罚（17s间隔适中）
reward_green_wave_weight: 8.0     # 最终优化：实验验证最优值（avg20=41979，+44.8%）
# 绿波奖励优化：实验验证最优权重为8.0（最终优化结果：avg20=41979）

# ========== 拥堵惩罚函数（论文优化：绿波优化后强化拥堵控制） ==========
# 占有率阈值降低：绿波畅通后，高占有率意味着真实拥堵问题
occ_penalty_start: 0.75  # 论文优化：降低阈值，更敏感检测拥堵（原0.80）
occ_penalty_power: 2.0   # 论文优化：提升幂次，加强惩罚力度（原1.5）
# 解释：offset=17s精确匹配后，绿波协调良好，若仍出现>0.75占有率则是真实拥堵

# ========== 优先级经验回放（PER）配置 ==========
use_per: false  # A/B测试结论：禁用PER（导致性能下降11.8%）
per_alpha: 0.6  # 优先级指数（0=均匀采样，1=完全优先级）
per_beta_start: 0.4  # 重要性采样权重初始值
per_beta_frames: 100000  # beta线性退火到1.0的帧数
per_epsilon: 1e-5  # 添加到优先级的小常数
n_step: 1  # A/B测试最优：单步TD（n_step=3配合PER会降低性能）

# ========== 日志监控配置 ==========
log_per_head_metrics: true  # 是否记录每头的详细指标
log_interval: 10  # 每N步记录一次详细日志
